<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule Consultation | DTS</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .week-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:1.5rem; margin-top:2rem; }
    .day-card { background:rgba(255,255,255,0.05); border-radius:15px; padding:1rem; }
    .day-card h4 { margin-bottom:0.5rem; }
    .time-btn { display:block; width:100%; margin:4px 0; padding:0.5rem; border:none; border-radius:8px; background:#14ff00; color:#000; cursor:pointer; font-weight:600; }
    .time-btn:disabled { opacity:0.4; cursor:not-allowed; }
    #book-form { display:none; margin-top:2rem; max-width:400px; }
  </style>
</head>
<body>
  <div id="tsparticles"></div>
  <header>
    <div class="container nav-container">
      <h1 class="logo">DTS</h1>
    </div>
  </header>
  <section class="section-hero">
    <div class="container hero-content" data-aos="fade-up">
      <h2 class="company-name">Book a Consultation</h2>
      <h3 class="tagline">Pick a slot next week</h3>
      <p class="subtitle">We offer 15-minute discovery calls to scope your AI / Web3 project.</p>
    </div>
  </section>

  <section class="section section-light">
    <div class="container" id="booking-wrapper">
      <div id="slots-section">
        <p style="text-align:center;">Loading available timesâ€¦</p>
      </div>

      <form id="book-form" class="contact-form">
        <h3 class="section-title" style="font-size:1.5rem;">Confirm Slot: <span id="chosen-slot"></span></h3>
        <div class="form-group"><input type="text" name="name" placeholder="Your Name" required></div>
        <div class="form-group"><input type="tel" name="phone" placeholder="Phone Number" required></div>
        <div class="form-group"><input type="email" name="email" placeholder="Email (confirmation)" required></div>
        <button type="submit" class="btn-primary">Book Consultation</button>
      </form>
    </div>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tsparticles/3.1.1/tsparticles.min.js"></script>
  <script>
    tsParticles.load('tsparticles', {fpsLimit:60,particles:{number:{value:90,density:{enable:true,area:800}},color:{value:['#14ff00','#00ffff']},shape:{type:'circle'},opacity:{value:0.4},size:{value:3},links:{enable:true,color:'#fff',opacity:0.1},move:{enable:true,speed:1.5,outMode:'out'}}});

    const slotSection=document.getElementById('slots-section');
    const form=document.getElementById('book-form');
    const chosenSpan=document.getElementById('chosen-slot');
    let chosenISO='';

    function groupByDate(arr){
      return arr.reduce((acc,iso)=>{const d=iso.split('T')[0];(acc[d]=acc[d]||[]).push(iso);return acc;},{});
    }

    async function loadSlots(){
      const res=await fetch('/api/availability');
      const {available}=await res.json();
      // keep only next 7 days
      const now=new Date();
      const end=new Date(now);end.setDate(now.getDate()+7);
      const week=available.filter(iso=>{const d=new Date(iso);return d>=now&&d<=end;});
      const grouped=groupByDate(week);
      renderSlots(grouped);
    }

    function renderSlots(grouped){
      slotSection.innerHTML='';
      const grid=document.createElement('div');grid.className='week-grid';
      Object.keys(grouped).sort().forEach(dateKey=>{
        const card=document.createElement('div');card.className='day-card';
        const h4=document.createElement('h4');h4.textContent=new Date(dateKey).toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'});
        card.appendChild(h4);
        grouped[dateKey].sort().forEach(iso=>{
          const btn=document.createElement('button');btn.className='time-btn';
          btn.textContent=new Date(iso).toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
          btn.addEventListener('click',()=>selectSlot(iso,btn));
          card.appendChild(btn);
        });
        grid.appendChild(card);
      });
      slotSection.appendChild(grid);
    }

    function selectSlot(iso,btn){
      chosenISO=iso;
      chosenSpan.textContent=new Date(iso).toLocaleString();
      form.style.display='block';
      document.querySelectorAll('.time-btn').forEach(b=>b.disabled=false);
      btn.disabled=true;
      form.scrollIntoView({behavior:'smooth'});
    }

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const data=Object.fromEntries(new FormData(form).entries());
      const res=await fetch('/api/book',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...data,slot:chosenISO})});
      if(res.ok){
        localStorage.setItem('lastSlot',chosenISO);
        localStorage.setItem('lastName',data.name);
        window.location.href='confirmation.html?slot='+encodeURIComponent(chosenISO);
      } else {
        const err=await res.json();alert(err.error||'Error booking');
      }
    });

    loadSlots();
  </script>
</body>
</html>